# AI Sales Operator — возможности агента и план развития

Документ для использования в ChatGPT при составлении плана развития продукта.

---

## 1. Что это за продукт

**AI Sales Operator** — B2B SaaS для автоматизации поддержки в e-commerce.

- Один интерфейс для диалогов из нескольких мессенджеров.
- ИИ (OpenAI GPT) предлагает ответы; оператор одобряет, правит или отклоняет перед отправкой.
- Мультитенантность (несколько магазинов/бизнесов).
- Подписка: 50 USDT/мес через CryptoBot, 3 дня триала.

---

## 2. Текущие функции по блокам

### 2.1 Каналы (мессенджеры)

- **Telegram Personal** — личный аккаунт через MTProto (gramjs), QR или код/2FA, сессии в БД, восстановление при старте.
- **WhatsApp Personal** — личный аккаунт через Baileys, сессии, восстановление.
- **MAX Personal** — отдельный Python-сервис (FastAPI + Playwright, web.max.ru), QR, пересылка сообщений в Node-бэкенд.

Каналы включаются по feature flags. Есть статус каналов, настройка (config), тест-отправка, отключение.

### 2.2 Диалоги и сообщения

- Список диалогов (фильтр по статусу: active, waiting, escalated, resolved).
- Режимы диалога: learning, semi-auto, auto.
- Отправка сообщений оператором (текст, вложения).
- Отметка прочитанным, счётчик непрочитанных.
- WebSocket для обновлений в реальном времени.

### 2.3 ИИ-подсказки и Decision Engine

- **Генерация подсказки** по последнему сообщению клиента: RAG (база знаний + товары), контекст клиента, few-shot примеры, настройки тенанта (язык, тон, «вы»/«ты»).
- **Классификация намерений (intents):** price, availability, shipping, return, discount, complaint, other.
- **Decision Engine** (опционально, по флагу):
  - Решение: AUTO_SEND / NEED_APPROVAL / ESCALATE по порогам (t_auto, t_escale) и self-check.
  - «Тройная блокировка» для автоотправки: глобальный флаг, настройка тенанта (autosendAllowed), список интентов для autosend (intentsAutosendAllowed), intentsForceHandoff.
- Действия по подсказке: **одобрить**, **редактировать и отправить**, **отклонить**, **эскалировать**.

### 2.3а PriceLookupWorker — поиск и оценка цен

- **Основной поиск** — `searchUsedTransmissionPrice` через **gpt-4.1 + web_search** (OpenAI Responses API): ищет реальные объявления на avito.ru, drom.ru, autopiter.ru в реальном времени.
- **AI-оценка (fallback)** — если основной поиск вернул менее 2 объявлений (`not_found`), вызывается `estimatePriceFromAI` через **gpt-4.1 + web_search**: GPT ищет текущие цены на drom.ru и avito.ru и возвращает диапазон `{priceMin, priceMax}`. Источник сохраняется как `ai_estimate`, TTL кэша — **2 часа** (быстро инвалидируется, чтобы не хранить устаревшие оценки).
- Модель **gpt-4o-mini** для оценки цен не используется — только gpt-4.1 с живым веб-поиском.

### 2.4 RAG (база знаний и товары)

- Документы базы знаний: категории, типы (policy, faq, delivery, returns), теги, чанки с эмбеддингами.
- Каталог товаров: SKU, название, описание, цена, наличие, варианты, доставка.
- Единый RAG-индекс (products + docs), поиск по эмбеддингам для контекста ответа.
- Админка: пересчёт эмбеддингов, инвалидация устаревших чанков.

### 2.5 Клиенты

- Профиль клиента: имя, телефон, email, теги, метаданные, канал.
- Заметки оператора по клиенту (CRUD).
- Память о клиенте: preferences, frequent_topics, lastSummaryText (ИИ-саммари).
- Пересборка саммари по кнопке (для админов).
- Удаление данных клиента (GDPR-ориентированная функция).

### 2.6 Обучение на действиях (training)

- **Training samples:** из одобрений/правок сохраняются пары (userMessage, aiSuggestion, finalAnswer, intent, outcome).
- **Training policies (по тенанту):** alwaysEscalateIntents, forbiddenTopics, disabledLearningIntents.
- **Few-shot:** выбор примеров по интенту для промпта генерации ответа.
- **Learning queue:** диалоги с высоким learning score (эскалации, правки, низкое сходство, длинный диалог, много отклонений) для разбора и экспорта.
- Экспорт сэмплов для дообучения/аналитики.

### 2.7 Эскалации

- Создание эскалации по подсказке (причина, саммари, предложенный ответ, что уточнить).
- Список эскалаций, статусы: pending, handled, dismissed.
- Настройки тенанта: escalationEmail, escalationTelegram, рабочие часы, автоответ вне часов.

### 2.8 Аналитика

- **Дашборд:** метрики (всего диалогов, активные, эскалации за период, и т.д.), недавние эскалации, активные диалоги.
- **CSAT:** оценка после диалога, агрегация по аналитике.
- **Конверсия:** отметка конверсии по диалогу, отчёты.
- **Интенты:** аналитика по типам намерений.
- **Lost deals:** учёт «потерянных» сделок и отчёты.

### 2.9 Онбординг

- Пошаговый онбординг (состояние: NOT_STARTED / IN_PROGRESS / DONE).
- Настройка магазина: имя, язык, тон, валюта, таймзона, рабочие часы, скидки, эскалация.
- Генерация шаблонов (база знаний, товары) через ИИ по описанию магазина.
- Применение сгенерированных шаблонов.
- Readiness: проверка готовности к работе (канал, база знаний, товары и т.д.).
- Smoke test онбординга (стрим результата).

### 2.10 Настройки тенанта

- Язык, тон (formal/friendly), обращение (vy/ty), валюта, таймзона.
- Рабочие часы и дни, автоответ вне часов.
- Эскалация: email, Telegram.
- Скидки: allowDiscounts, maxDiscountPercent.
- **Decision settings:** t_auto, t_escale, autosendAllowed, intentsAutosendAllowed, intentsForceHandoff.
- **Human delay:** включение, профили задержки (SHORT/MEDIUM/LONG), ночной режим (AUTO_REPLY/DELAY/DISABLE), множитель задержки ночью, текст автоответа ночью, индикатор «печатает».

### 2.11 Подписка и биллинг

- Подписка через CryptoBot (Crypto Pay API): 50 USDT/мес, план в БД.
- Триал 3 дня при первом входе (по логике биллинга).
- Gating: без активной подписки часть функций недоступна (middleware requireActiveSubscription).

### 2.12 Пользователи и роли

- Роли: owner, admin, operator, viewer, guest.
- Права (RBAC): VIEW_CONVERSATIONS, MANAGE_CONVERSATIONS, VIEW/MANAGE_CUSTOMERS, DELETE_CUSTOMER_DATA, VIEW_ANALYTICS, MANAGE_PRODUCTS, MANAGE_KNOWLEDGE_BASE, MANAGE_AUTOSEND, MANAGE_POLICIES, MANAGE_TRAINING, EXPORT_TRAINING_DATA, MANAGE_CHANNELS, MANAGE_TENANT_SETTINGS, MANAGE_USERS, VIEW_AUDIT_LOGS.
- Регистрация/логин по email и паролю, верификация email, сброс пароля.
- Приглашения в тенант по email (инвайты с токеном, истечение срока).
- Сессия в PostgreSQL (express-session), 1 неделя TTL.

### 2.13 Платформенная админка и владелец

- **Platform admin / owner:** отдельные флаги у пользователя (isPlatformAdmin, isPlatformOwner).
- Маршруты: /admin/security, /admin/billing, /admin/secrets, /admin/users, /admin/proxies.
- **Owner:** /owner, /owner/login, /owner/updates, дашборд владельца платформы.
- Управление тенантами (ограничение/разблокировка), пользователями, грантами подписки, секретами, прокси.
- Аудит админ-действий (admin_actions): тип действия, цель, причина, предыдущее состояние.
- Имперсонация пользователя (для поддержки).

### 2.14 Безопасность и фрод

- Статусы тенанта: active, restricted (фрод-защита).
- Секреты интеграций: шифрование мастер-ключом (INTEGRATION_SECRETS_MASTER_KEY).
- Санитизация логов (маскирование API keys и т.д.).
- Rate limiting: общий на API, отдельно на AI, на онбординг, на вебхуки, на диалоги по тенанту.
- Защита вебхуков (Telegram, WhatsApp, MAX): проверка подписи/токена.

### 2.15 Товары и база знаний (CRUD)

- Товары: создание, редактирование, удаление, импорт (например CSV).
- Документы базы знаний: создание, редактирование, удаление; категория, тип, теги.

### 2.16 Очередь отложенных сообщений

- Отправка с задержкой (BullMQ): учёт human delay, ночного режима, «печатает».
- Админка: просмотр отложенных задач, метрики очереди, отмена.

---

## 3. Feature flags (что включено/выключено)

- **AI_SUGGESTIONS_ENABLED** — вкл. (подсказки ИИ).
- **RAG_ENABLED** — вкл. (RAG-контекст).
- **FEW_SHOT_LEARNING** — вкл. (few-shot в промпте).
- **DECISION_ENGINE_ENABLED** — выкл. (решение AUTO_SEND/NEED_APPROVAL/ESCALATE).
- **AI_AUTOSEND_ENABLED** — выкл. (автоотправка без одобрения).
- **HUMAN_DELAY_ENABLED** — выкл. (задержка перед ответом).
- **TELEGRAM_CHANNEL_ENABLED** — выкл. (бот Telegram, не личный).
- **WHATSAPP_CHANNEL_ENABLED** — выкл. (WhatsApp Business API).
- **MAX_CHANNEL_ENABLED** — выкл. (MAX канал, не личный).
- **TELEGRAM_PERSONAL_CHANNEL_ENABLED** — вкл.
- **WHATSAPP_PERSONAL_CHANNEL_ENABLED** — вкл.
- **MAX_PERSONAL_CHANNEL_ENABLED** — вкл.

---

## 4. Технологический стек

- **Backend:** Node.js, Express, TypeScript, Drizzle ORM, PostgreSQL, Redis (сессии/очереди), BullMQ.
- **AI:** OpenAI API (чат, эмбеддинги).
- **Каналы:** Telegram (gramjs), WhatsApp (Baileys), MAX (отдельный Python-сервис на FastAPI + Playwright).
- **Frontend:** React, Vite, Wouter, TanStack Query, shadcn/ui, Tailwind.
- **Деплой:** PM2 (ecosystem.config.cjs).

---

## 5. Что можно развивать (идеи для плана в ChatGPT)

- Включить и донастроить **Decision Engine** и **AI Autosend** (безопасные сценарии, мониторинг).
- Включить **Human Delay** и донастроить профили под разные типы ответов.
- Дополнительные **каналы**: VK, Instagram, чат на сайте, email.
- Улучшение **RAG**: гибридный поиск, переранжирование, фильтры по типу документа/товара.
- **Мультиязычность** интерфейса и ответов ИИ.
- **Отчёты и дашборды**: экспорт в PDF/Excel, дашборды под менеджеров.
- **Интеграции**: CRM, 1C, маркетплейсы (синхронизация заказов/товаров).
- **Голос/медиа**: распознавание голоса, генерация голоса, разметка вложений.
- **A/B тесты** ответов ИИ или сценариев.
- **Улучшение обучения:** автоматический отбор примеров для few-shot, дообучение своей модели.
- **Безопасность:** 2FA для операторов, более строгие политики паролей, аудит экспорта данных.
- **Масштабирование:** очереди по приоритетам, лимиты по тарифам, мультирегион.

---

## 6. Как использовать этот документ в ChatGPT

Скопируй разделы 1–4 в чат и напиши, например:

«Это описание нашего продукта AI Sales Operator и всех текущих функций. На основе этого составь пошаговый план развития на 3/6/12 месяцев: приоритеты, зависимости, риски и метрики успеха. Учитывай, что Decision Engine и Autosend сейчас выключены, а основные каналы — личные Telegram, WhatsApp, MAX.»

Можно добавить свои ограничения (бюджет, команда, сроки) и цели (например «увеличить автоответы без потери качества» или «добавить канал VK»).
