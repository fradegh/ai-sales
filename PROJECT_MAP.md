# AI Sales Operator — Complete Project Map

> Generated by full codebase audit on 2026-02-20.
> Based ONLY on code analysis — not on existing documentation.

---

## Project Overview

AI Sales Operator is a **multi-tenant B2B SaaS platform** for automating customer service via messenger channels. The core business domain is **contract gearboxes (КПП)** — the system detects VIN/FRAME numbers from customer messages, looks up gearbox OEM codes via web-scraping services, and fetches market prices from Avito/Drom/web search.

**Target users:** Businesses selling contract auto parts (gearboxes), who need AI-assisted customer communication across Telegram, WhatsApp, and MAX messengers.

**Core business flow:**
1. Customer writes to a business Telegram/WhatsApp/MAX personal account
2. System detects VIN/FRAME → looks up gearbox OEM via Podzamenu/Prof-RF
3. Price cascade: internal DB → Avito → Drom → SerpAPI → mock fallback
4. AI generates a response via Decision Engine (GPT-4o-mini + RAG + few-shot)
5. Operator approves/edits/rejects the suggestion, or it auto-sends if confidence is high enough

**Monetization:** 50 USDT/month via CryptoBot (Telegram payment bot), 3-day free trial. Stripe integration exists but CryptoBot is primary.

---

## Tech Stack

### Node.js / TypeScript Backend
| Package | Version | Purpose |
|---------|---------|---------|
| express | ^4.21.2 | HTTP server |
| drizzle-orm | ^0.39.3 | ORM for PostgreSQL |
| drizzle-kit | ^0.31.8 | Migration tooling |
| pg | ^8.16.3 | PostgreSQL driver |
| bullmq | ^5.66.4 | Job queues (Redis-backed) |
| ioredis | ^5.9.0 | Redis client |
| openai | ^6.15.0 | OpenAI API (GPT-4o-mini, embeddings) |
| telegram | ^2.26.22 | MTProto (gramjs) for Telegram Personal |
| @whiskeysockets/baileys | ^7.0.0-rc.9 | WhatsApp Personal (unofficial API) |
| @foile/crypto-pay-api | ^1.0.4 | CryptoBot billing |
| stripe | ^20.2.0 | Stripe billing (secondary) |
| cheerio | ^1.2.0 | HTML parsing for Avito/Drom |
| ws | ^8.18.0 | WebSocket server |
| bcrypt | ^6.0.0 | Password hashing |
| passport | ^0.7.0 | Auth (configured but session-based in practice) |
| zod | ^3.25.76 | Validation |
| pino | ^10.1.0 | Logging |
| p-limit | ^7.2.0 | Concurrency control |
| p-retry | ^7.1.1 | Retry logic |
| typescript | 5.6.3 | Language |

### React Frontend
| Package | Version | Purpose |
|---------|---------|---------|
| react | ^18.3.1 | UI framework |
| vite | ^7.3.0 | Build tool / dev server |
| @vitejs/plugin-react | ^4.7.0 | React Vite plugin |
| tailwindcss | ^3.4.17 | CSS framework |
| @tanstack/react-query | ^5.60.5 | Data fetching/caching |
| wouter | ^3.3.5 | Client-side routing |
| shadcn/ui (Radix primitives) | various | UI component library |
| recharts | ^2.15.2 | Charts for analytics |
| framer-motion | ^11.13.1 | Animations |
| lucide-react | ^0.453.0 | Icons |
| cmdk | ^1.1.1 | Command palette |
| react-hook-form | ^7.55.0 | Form handling |

### Python Services
| Package | Version | Purpose |
|---------|---------|---------|
| fastapi | >=0.128.0 | Web framework |
| playwright | >=1.57.0 | Browser automation |
| uvicorn | >=0.40.0 | ASGI server |
| pydantic | >=2.12.5 | Data validation |
| maxapi-python | >=1.2.5 | MAX API client |
| qrcode | >=8.2 | QR code generation |
| httpx | >=0.28.1 | HTTP client |
| aiohttp | >=3.13.3 | Async HTTP |
| pillow | >=12.1.0 | Image processing |
| Python | >=3.11 | Runtime |

### Infrastructure
- **Database:** PostgreSQL (via Drizzle ORM)
- **Queue/Cache:** Redis (via ioredis + BullMQ)
- **Process Manager:** PM2 (ecosystem.config.cjs)
- **Deployment:** Nixpacks (Node 20), Docker support
- **Build:** esbuild (server → CJS), Vite (client → static)

---

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                     React Frontend (Vite)                    │
│  Pages: Dashboard, Conversations, Analytics, Settings, etc.  │
│  State: TanStack Query + WebSocket for realtime              │
└──────────────────────────┬──────────────────────────────────┘
                           │ HTTP API + WebSocket (/ws)
┌──────────────────────────┴──────────────────────────────────┐
│                   Express.js Backend                         │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Auth + RBAC  │  │   Routes     │  │  Middleware   │      │
│  │  (session)   │  │ (REST API)   │  │ (rate limit,  │      │
│  └──────────────┘  └──────┬───────┘  │  validation)  │      │
│                           │          └──────────────┘      │
│  ┌────────────────────────┴─────────────────────────┐      │
│  │              Service Layer                        │      │
│  │  ┌─────────────────────────────────────────────┐  │      │
│  │  │ Inbound Message Handler (central pipeline)  │  │      │
│  │  │  → VIN/FRAME detection                      │  │      │
│  │  │  → AI Suggestion (Decision Engine)          │  │      │
│  │  │  → Vehicle Lookup Queue (BullMQ)            │  │      │
│  │  │  → Price Lookup Queue (BullMQ)              │  │      │
│  │  └─────────────────────────────────────────────┘  │      │
│  │                                                    │      │
│  │  Channel Adapters:                                │      │
│  │  • Telegram Personal (MTProto/gramjs)             │      │
│  │  • WhatsApp Personal (Baileys)                    │      │
│  │  • MAX Personal (Python service client)           │      │
│  │  • Telegram Bot API (stub)                        │      │
│  │  • WhatsApp Business API (stub)                   │      │
│  │  • MAX Bot API (stub)                             │      │
│  └───────────────────────────────────────────────────┘      │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   BullMQ     │  │   WebSocket  │  │   Billing    │      │
│  │   Workers    │  │   Server     │  │  (CryptoBot) │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└──────────────────────────┬──────────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
  ┌─────┴─────┐    ┌──────┴──────┐    ┌──────┴──────┐
  │ PostgreSQL │    │    Redis    │    │   OpenAI    │
  │  (Drizzle) │    │  (BullMQ)  │    │  GPT-4o-mini│
  │  45 tables │    │  3 queues  │    │  Embeddings │
  └───────────┘    └─────────────┘    └─────────────┘

  ┌───────────────────────────────────────────────┐
  │            Python Microservices                │
  │  ┌────────────────┐  ┌──────────────────────┐ │
  │  │ MAX Personal   │  │ Podzamenu Lookup     │ │
  │  │ (port 8100)    │  │ (port 8200)          │ │
  │  │ Playwright     │  │ Playwright + FastAPI  │ │
  │  │ web.max.ru     │  │ podzamenu.ru/prof-rf │ │
  │  └────────────────┘  └──────────────────────┘ │
  └───────────────────────────────────────────────┘
```

---

## File Structure with Descriptions

### Root Configuration
| File | Description |
|------|-------------|
| `package.json` | Node.js deps and scripts. Entry: `server/index.ts`. Build: `script/build.ts` |
| `tsconfig.json` | TypeScript config. Strict mode, ESNext, path aliases `@/*` and `@shared/*` |
| `vite.config.ts` | Vite: React plugin, path aliases, build to `dist/public/` |
| `drizzle.config.ts` | Drizzle ORM: PostgreSQL, schema at `shared/schema.ts`, migrations to `./migrations` |
| `tailwind.config.ts` | Tailwind with shadcn/ui theme (dark mode, status colors, sidebar variants) |
| `postcss.config.js` | PostCSS: Tailwind + Autoprefixer |
| `components.json` | shadcn/ui config: "new-york" style, CSS variables, neutral base |
| `ecosystem.config.cjs` | PM2: main app (`dist/index.cjs`) + price-lookup worker |
| `nixpacks.toml` | Deployment: Node 20, npm install, build, start |
| `start.sh` | Startup: `drizzle-kit push --force` then `npm run start` |
| `pyproject.toml` | Python 3.11+ deps: FastAPI, Playwright, MAX API, etc. |
| `.env.example` | All env vars with descriptions (110 lines) |
| `feature_flags.json` | 13 feature flags with default values |
| `.gitignore` | Standard Node + Python + IDE ignores |
| `.dockerignore` | Excludes node_modules, __pycache__, .env, dist, .git |
| `script/build.ts` | Build script: Vite frontend + esbuild server bundle |

### `/shared/` — Shared Types and Schema
| File | Description |
|------|-------------|
| `schema.ts` | **Main database schema** — 45 Drizzle tables, all enums/constants, Zod insert schemas, exported types. Central source of truth for DB structure. |
| `models/auth.ts` | Session table (connect-pg-simple) + `authUsers` table for OIDC profiles |
| `models/chat.ts` | **Legacy** chat schema (serial IDs, no multi-tenancy). Likely unused. |

### `/server/` — Backend Core
| File | Description |
|------|-------------|
| `index.ts` | Express app entry. Startup: config validation, middleware, routes, WebSocket, session restore for all channels, MAX Personal Python child process spawn |
| `db.ts` | PostgreSQL pool + Drizzle instance |
| `config.ts` | Zod-based env validation. `validateConfig()`, `getConfig()`, `checkRequiredServices()` |
| `storage.ts` | `IStorage` interface (80+ methods), exports `storage` as `DatabaseStorage` |
| `database-storage.ts` | `DatabaseStorage` — full PostgreSQL implementation of `IStorage`. All CRUD for every table. |
| `session.ts` | Express session with `connect-pg-simple` PostgreSQL store. 7-day TTL. |
| `static.ts` | Serve static frontend build in production (SPA fallback) |
| `vite.ts` | Vite dev server middleware with HMR |

### `/server/routes/` — HTTP Routes
| File | Description |
|------|-------------|
| `routes.ts` | **Central route registration** — 100+ endpoints covering tenants, customers, conversations, AI, settings, channels, billing, analytics, vehicle lookup, price lookup, admin. Mounts sub-routers. |
| `auth.ts` | Auth router (`/auth/*`): signup, login, logout, invite, email verification, password reset. Rate limited. |
| `auth-api.ts` | `GET /api/auth/user` — session-based current user info |
| `admin.ts` | Platform admin API: billing metrics, tenant/user management, secrets, proxies, updates, impersonation |
| `phase0.ts` | Feature flags CRUD + audit log query endpoints |
| `health.ts` | `GET /health`, `GET /ready`, `GET /metrics` |
| `telegram-webhook.ts` | Telegram Bot API webhook (Business). Validates, deduplicates, logs. Does NOT call AI or save to DB. |
| `whatsapp-webhook.ts` | WhatsApp Business API webhook. HMAC verification. Does NOT call AI. |
| `max-webhook.ts` | MAX Bot API webhook. Optional secret verification. Calls `processInboundMessage`. |

### `/server/services/` — Business Logic

#### Message Pipeline
| File | Description |
|------|-------------|
| `inbound-message-handler.ts` | **Central inbound pipeline.** `processIncomingMessageFull` → normalize text → detect VIN/FRAME → find/create customer & conversation → deduplicate → save message → broadcast WebSocket → create vehicle lookup case → trigger AI suggestion. All Personal channels converge here. |
| `decision-engine.ts` | AI generation: RAG context → few-shot → GPT-4o-mini → intent detection → confidence scoring → penalties → decision (AUTO_SEND/NEED_APPROVAL/ESCALATE) → self-check → autosend eligibility |
| `message-queue.ts` | BullMQ queue `message_send_queue` for delayed message sending (human-like delay). Redis-backed. |
| `websocket-server.ts` | WebSocket server on `/ws`. Authenticates via session cookie on HTTP upgrade. Tenant bound from session — clients cannot override. Broadcasts: new_message, conversation_update, new_conversation, new_suggestion. |

#### Channel Adapters
| File | Description |
|------|-------------|
| `channel-adapter.ts` | `ChannelAdapter` interface, `ChannelRegistry`, `processInboundMessage`/`processOutboundMessage`, stub adapters, feature flag gating per channel |
| `telegram-adapter.ts` | Telegram Bot API: send messages, webhook verification, message parsing. Uses `fetch`. |
| `telegram-personal-adapter.ts` | Telegram Personal via MTProto (gramjs): phone/QR/2FA auth, send messages, parse MTProto payloads. Single-session (multi-account via manager). |
| `telegram-client-manager.ts` | **Multi-account Telegram manager.** Connects/disconnects accounts, handles incoming → `processIncomingMessageFull`, dialog sync, heartbeat, reconnection. Key: `tenantId:accountId`. |
| `whatsapp-adapter.ts` | WhatsApp Business API: send messages, template messages, 24h care window, HMAC webhook verify |
| `whatsapp-personal-adapter.ts` | WhatsApp Personal via Baileys: QR auth, session persistence (filesystem), send messages, incoming → `processIncomingMessageFull` |
| `max-adapter.ts` | MAX Bot API: send messages, webhook verify, message parsing |
| `max-personal-adapter.ts` | MAX Personal: HTTP client to Python service (port 8100). Auth, send messages, health check. |

#### AI / RAG
| File | Description |
|------|-------------|
| `rag-retrieval.ts` | RAG retrieval: embed query → cosine similarity against all tenant chunks → return top product + doc results |
| `rag-indexer.ts` | RAG document builder: products → logical blocks, knowledge docs → paragraph chunks with overlap. SHA-256 content hashes. |
| `few-shot-builder.ts` | Few-shot prompt builder from training samples. Filters by outcome, ranks by confidence, respects token budget. |
| `embedding-service.ts` | OpenAI embeddings via `text-embedding-3-large` (3072 dimensions). Gated by `RAG_ENABLED`. |
| `document-chunking-service.ts` | Document chunking: paragraphs + sentences with overlap. Token estimate: `words * 1.3`. |

#### Vehicle Lookup
| File | Description |
|------|-------------|
| `vehicle-lookup-queue.ts` | BullMQ queue `vehicle_lookup_queue`. Jobs: caseId, tenantId, conversationId, idType, normalizedValue. |
| `podzamenu-lookup-client.ts` | HTTP client to Python Podzamenu service (port 8200). POST `/lookup` with VIN/FRAME. |
| `gearbox-templates.ts` | 5 Russian templates for gearbox lookup replies. Placeholder substitution: `{{oem}}`, `{{model}}`, `{{source}}`, etc. Tenant override merge. |

#### Price Engine
| File | Description |
|------|-------------|
| `price-lookup-queue.ts` | BullMQ queue `price_lookup_queue`. Jobs: tenantId, conversationId, oem or searchFallback. |
| `price-sources/types.ts` | Shared types: `PriceSource`, `PriceResult`, `ListingItem`, `GearboxType`. `detectGearboxType()` with keyword maps (АКПП/МКПП/Вариатор/DSG/РКПП). |
| `price-sources/avito-source.ts` | Avito HTML parsing via cheerio. Selectors: `[data-marker='item']`, `[itemprop='price']`. Timeout 15s. |
| `price-sources/drom-source.ts` | Drom (baza.drom.ru) HTML parsing. Category-specific URLs per gearbox type. Timeout 15s. |
| `price-sources/web-source.ts` | SerpAPI organic results. Price regex extraction. Timeout 20s. Requires `SERP_API_KEY`. |
| `price-sources/mock-source.ts` | Fixed mock prices (1000, 1500, 1200 RUB). Final fallback. Never saved to internal_prices. |

#### Billing
| File | Description |
|------|-------------|
| `billing-service.ts` | Stripe billing: plan creation, checkout sessions, webhook handling (subscription lifecycle), grants, billing status |
| `cryptobot-billing.ts` | CryptoBot billing: USDT invoices, webhook verification (HMAC), trial management (72h), expired subscription creation for fraud prevention |

#### Analytics & Learning
| File | Description |
|------|-------------|
| `csat-service.ts` | CSAT ratings (1-5). One per conversation. Analytics with breakdown by intent/decision. |
| `conversion-service.ts` | Conversion tracking. One per conversation. **BUG: `conversionRate` always 100%** (divides totalConversions by itself). |
| `lost-deals-service.ts` | Auto-detect lost deals: ESCALATED_NO_RESPONSE (30 min), AI_ERROR, NO_STOCK. Analytics by reason/intent. |
| `intent-analytics-service.ts` | Per-intent analytics: autosend rate, escalation rate, confidence, CSAT, conversion. Status thresholds. |
| `customer-summary-service.ts` | GPT-4o-mini customer summary from conversation history. Up to 6 bullets. Upserts to customer memory. |
| `learning-score-service.ts` | Learning queue scoring from suggestion outcomes. Scores for ESCALATED, EDITED, LOW_SIMILARITY, STALE_DATA, LONG_CONVERSATION. |
| `training-sample-service.ts` | AI training samples: record, query, export. Forbidden topic filtering. |

#### Auth & Security
| File | Description |
|------|-------------|
| `auth-service.ts` | Auth: signup (invite or auto-provision), login (with lockout after 5 fails), password reset, email verification. Starts trial on signup. |
| `owner-bootstrap.ts` | Creates/promotes platform owner at startup from env vars (OWNER_EMAIL, OWNER_PASSWORD). |
| `feature-flags.ts` | In-memory + JSON file feature flags. 13 defaults. Global and tenant-specific scopes. |
| `secret-store.ts` | AES-256-GCM encryption for integration secrets. Master key from env. |
| `secret-resolver.ts` | Resolve encrypted secrets with in-memory cache (500 entries, 60s TTL). |
| `fraud-detection-service.ts` | Channel fingerprint hashing (SHA-256), channel reuse detection, trial eligibility checks, tenant restriction. |
| `security-readiness.ts` | Security readiness report. **Note: webhook/rate-limit/data-deletion checks always return true.** |
| `audit-log.ts` | In-memory audit events. **Events lost on restart — not persisted to DB.** |

#### Other Services
| File | Description |
|------|-------------|
| `email-provider.ts` | Email abstraction. **Only `ConsoleEmailProvider` implemented** — logs to console, never sends real email. |
| `smoke-test-service.ts` | Decision Engine smoke test: 5 hardcoded questions, PASS/WARN/FAIL thresholds. |
| `onboarding-templates.ts` | Generate onboarding docs (policy, FAQ, delivery, returns) via GPT-4o. Fallback templates if AI fails. |
| `human-delay-engine.ts` | Calculate human-like delay: base + typing simulation + jitter. Working hours vs night modes. |
| `proxy-service.ts` | Proxy management: CRUD, assignment to channels, URL building. |
| `update-service.ts` | OTA updates: ZIP upload, unzip, apply, backup, rollback. Unix-only (uses `unzip`, `cp`). |

### `/server/workers/` — BullMQ Workers
| File | Description |
|------|-------------|
| `vehicle-lookup.worker.ts` | Processes VIN/FRAME lookups: call Python service → compute confidence → cache → create suggestion → auto-trigger price lookup if confidence ≥ 0.85 or fallback mode |
| `price-lookup.worker.ts` | Price cascade: cache (60 min) → internal → Avito → Drom → web → mock. Commercial logic (marginPct, roundTo). Auto-save to internal_prices. |
| `message-send.worker.ts` | Delayed message sending. **Note: `isMessageStillValid()` always returns true; `markMessageAsSent/Failed` only log, no DB update.** |

### `/server/middleware/`
| File | Description |
|------|-------------|
| `rbac.ts` | Role-based access: 5 roles (owner→admin→operator→viewer→guest), 15 permissions. **Production always returns `operator` role — no real session/JWT auth yet.** |
| `rate-limiter.ts` | In-memory rate limiting. Global + tenant-specific. Cleanup every 60s. |
| `error-handler.ts` | Central error handler: Zod → 400, operational → status code, stack in dev only. |
| `request-context.ts` | Request ID (X-Request-Id or UUID). Sets audit context. |
| `validation.ts` | Zod validation middleware. Payload limits (2MB body, 4000 chars message). |
| `webhook-security.ts` | HMAC-SHA256 webhook verification for Telegram/WhatsApp/MAX. Timing-safe compare. |
| `platform-admin.ts` | Restrict routes to `isPlatformAdmin`. |
| `platform-owner.ts` | Restrict routes to `isPlatformOwner`. |
| `fraud-protection.ts` | Block access when tenant is restricted. |

### `/server/utils/`
| File | Description |
|------|-------------|
| `sanitizer.ts` | PII masking: API keys, JWT, email, phone, credit cards, Russian names/addresses. |

### `/server/batch/`
| File | Description |
|------|-------------|
| `utils.ts` | Batch processing with p-limit concurrency and p-retry. Rate limit (429) detection. |
| `index.ts` | Re-exports from `./utils` |

### `/server/replit_integrations/batch/`
| File | Description |
|------|-------------|
| `utils.ts` | **Duplicate** of `server/batch/utils.ts`. Likely obsolete Replit leftover. |

### `/server/scripts/`
| File | Description |
|------|-------------|
| `migrate.ts` | Standalone migration script: calls `npx drizzle-kit push`. |

### `/server/tests/` and `/server/__tests__/` — Test Files (49 total)
Tests use **Vitest**. Covers: decision engine, RBAC, webhooks, rate limiting, CSAT, conversions, customer data deletion, admin actions, secrets, sanitizer, RAG, embeddings, onboarding, smoke tests, learning score, training policies, subscription grants, fraud detection, etc.

### `/client/` — React Frontend

#### Core
| File | Description |
|------|-------------|
| `index.html` | Entry HTML. 20+ Google Fonts preloaded. |
| `src/main.tsx` | React entry: mounts `App` into `#root` |
| `src/App.tsx` | Main app with routing (wouter). Landing page, auth pages, authenticated shell with sidebar. Redirects to `/onboarding` if not completed. |
| `src/index.css` | Tailwind base + dark/light theme CSS variables. |

#### Pages (20 pages)
| Page | Route | Description |
|------|-------|-------------|
| `auth.tsx` | `/login`, `/signup`, `/verify-email`, `/forgot-password`, `/reset-password` | Auth forms. Invite support via query param. |
| `dashboard.tsx` | `/` | Overview metrics, recent escalations, active conversations. **Hardcoded trend values.** |
| `conversations.tsx` | `/conversations` | Conversation list + chat interface. AI suggestion approve/edit/reject/escalate. Manual message send. Phone-based conversation start for Telegram. |
| `customer-profile.tsx` | `/customers/:id` | Customer details, tags, notes, memory, conversation history. |
| `analytics.tsx` | `/analytics` | CSAT, conversion, intent, lost-deal analytics with charts. |
| `settings.tsx` | `/settings` | Decision Engine, Human Delay, Training Policies, all channel configs (Telegram Bot/Personal, WhatsApp, MAX). ~3000+ lines. |
| `billing.tsx` | `/billing` | Subscription management. CryptoBot checkout. 50 USDT/month. |
| `escalations.tsx` | `/escalations` | Escalation list and resolution actions. |
| `knowledge-base.tsx` | `/knowledge-base` | Knowledge docs CRUD. |
| `products.tsx` | `/products` | Product catalog CRUD + CSV import. |
| `onboarding.tsx` | `/onboarding` | 6-step wizard: Business → Channels → Products → Policies → KB → Review. |
| `security-status.tsx` | `/admin/security` | Security readiness report + system metrics. |
| `admin-billing.tsx` | `/admin/billing` | Platform billing metrics (admin). |
| `admin-users.tsx` | `/admin/users` | User search, disable/enable, impersonate, grant subscription. |
| `admin-secrets.tsx` | `/admin/secrets` | Global integration secrets management. |
| `admin-proxies.tsx` | `/admin/proxies` | Proxy CRUD and bulk import. |
| `owner-login.tsx` | `/owner/login` | Platform owner login. |
| `owner-dashboard.tsx` | `/owner` | Owner console with admin links. |
| `owner-updates.tsx` | `/owner/updates` | System update upload, apply, rollback, rebuild. |
| `not-found.tsx` | `*` | 404 page. |

#### Components
| File | Description |
|------|-------------|
| `app-sidebar.tsx` | Navigation sidebar with unread/escalation badges |
| `chat-interface.tsx` | Chat UI: messages, AI suggestions with confidence/decision badges, manual input, CSAT |
| `conversation-list.tsx` | Conversation list with status indicators. **Search input is non-functional** (not wired). |
| `customer-card.tsx` | Customer info card with tags and channel icons |
| `metrics-card.tsx` | Metric display component with trend indicator |
| `csat-dialog.tsx` | 1-5 star CSAT rating dialog |
| `subscription-paywall.tsx` | Paywall overlay, subscription badge, channel lock |
| `theme-toggle.tsx` | Light/Dark/System theme toggle |
| `ui/*.tsx` | 40+ shadcn/ui components (Button, Card, Dialog, Form, etc.) |

#### Hooks and Libraries
| File | Description |
|------|-------------|
| `hooks/use-auth.ts` | Auth state: user, loading, logout. Polls `GET /api/auth/user`. |
| `hooks/use-billing.ts` | Billing state: status, checkout, cancel. |
| `hooks/use-mobile.tsx` | Mobile breakpoint detection (768px). |
| `hooks/use-toast.ts` | Toast notification state. |
| `lib/auth-utils.ts` | Unauthorized handling. **BUG: redirects to `/api/login` instead of `/login`.** |
| `lib/websocket.ts` | WebSocket client. Connects to `/ws`, listens for realtime events, invalidates TanStack Query caches. |
| `lib/utils.ts` | `cn()` utility for Tailwind class merging. |
| `lib/theme-provider.tsx` | Theme context provider. Storage key: `ai-sales-operator-theme`. |
| `lib/queryClient.ts` | TanStack Query client + `apiRequest` fetch wrapper. `staleTime: Infinity`. |

### Python Files (Root)
| File | Description |
|------|-------------|
| `max_personal_service.py` | FastAPI service (port 8100). MAX Personal auth via Playwright (web.max.ru QR capture). Session management, message sending, incoming message forwarding to Node backend. |
| `podzamenu_lookup_service.py` | FastAPI service (port 8200). VIN/FRAME lookup via Playwright. Parses podzamenu.ru (React SPA, MUI) and prof-rf. Multiple navigation strategies (accordion, tabs, legacy links). OEM extraction and validation. |
| `test_regression_iter4.py` | Regression test: 48 VINs/FRAMEs against Podzamenu service. Validates OEM extraction. |

### `/migrations/` — Database Migrations (11 files)
| File | Description |
|------|-------------|
| `0000_pre_migration_check_duplicates.sql` | Diagnostic: find duplicate emails before uniqueness enforcement |
| `0001a_normalize_emails.sql` | Normalize emails: lowercase + trim |
| `0002_subscription_grants_indexes.sql` | Index on `subscription_grants` for active grant lookups |
| `0003_vehicle_lookup_tables.sql` | Create `vehicle_lookup_cache` + `vehicle_lookup_cases` tables |
| `0004_tenants_templates.sql` | Add `templates` JSONB column to tenants |
| `0005_price_snapshots.sql` | Create `price_snapshots` table |
| `0006_internal_prices.sql` | Create `internal_prices` table |
| `0006_telegram_multiaccount.sql` | Telegram multi-account: nullable phone, `auth_method`, `is_enabled`, tenant index |
| `0007_price_commercial.sql` | Add market_* and sale_price fields to price_snapshots |
| `0008_price_snapshot_search_key.sql` | Add `search_key` to price_snapshots for fallback search |
| `manual/0001b_create_email_unique_index.sql` | Manual: unique partial index on `LOWER(email)` with CONCURRENTLY |

---

## Database Schema

### 45 Tables (from `shared/schema.ts` and migrations)

#### Core Multi-tenant
| Table | Key Columns | Purpose |
|-------|-------------|---------|
| `tenants` | id, name, language, tone, timezone, workingHours, status, templates (jsonb) | Tenant configuration |
| `channels` | id, tenantId, type, name, config (jsonb), isActive | Channel definitions |

#### Users & Auth
| Table | Key Columns | Purpose |
|-------|-------------|---------|
| `users` | id, tenantId, username, password, role, email, isPlatformAdmin, isPlatformOwner, isDisabled, failedLoginAttempts, lockedUntil | User accounts |
| `sessions` | sid, sess, expire | Express sessions (connect-pg-simple) |
| `authUsers` | id, email, firstName, lastName, profileImageUrl | OIDC profile storage |
| `userInvites` | id, tenantId, email, role, tokenHash, expiresAt | User invitations |
| `emailTokens` | id, userId, tokenHash, type (verification/reset), expiresAt | Email verification & password reset tokens |
| `adminActions` | id, actionType, targetType, targetId, adminId, reason, previousState | Admin action audit trail |

#### Customers & Conversations
| Table | Key Columns | Purpose |
|-------|-------------|---------|
| `customers` | id, tenantId, channelId, channel, externalId, name, phone, email, tags, metadata | Customer records. Unique: (tenantId, channel, externalId) |
| `customerNotes` | id, tenantId, customerId, authorUserId, noteText | Operator notes on customers |
| `customerMemory` | id, tenantId, customerId, preferences, frequentTopics, lastSummaryText | AI-generated customer context |
| `conversations` | id, tenantId, customerId, channelId, status, mode, lastMessageAt, unreadCount | Conversation threads |
| `messages` | id, conversationId, role, content, attachments, metadata | Chat messages |

#### AI & Decision Engine
| Table | Key Columns | Purpose |
|-------|-------------|---------|
| `aiSuggestions` | id, conversationId, suggestedReply, intent, confidence, decision, status, penalties, autosendEligible, selfCheckScore | AI-generated suggestions with Decision Engine metadata |
| `humanActions` | id, suggestionId, userId, action (approve/edit/reject/escalate), editedText | Human feedback on suggestions |
| `aiTrainingSamples` | id, tenantId, conversationId, userMessage, aiSuggestion, finalAnswer, intent, outcome | Training data from human feedback |
| `aiTrainingPolicies` | tenantId (PK), alwaysEscalateIntents, forbiddenTopics, disabledLearningIntents | Per-tenant training policies |
| `learningQueue` | id, tenantId, conversationId, learningScore, reasons, status | Items needing review |
| `escalationEvents` | id, conversationId, reason, summary, status | Escalated conversations |
| `responseTemplates` | id, tenantId, name, content, category, triggers, usageCount | Response templates |
| `decisionSettings` | tenantId (PK), tAuto, tEscalate, autosendAllowed, intentsAutosendAllowed | Per-tenant Decision Engine thresholds |
| `humanDelaySettings` | tenantId (PK), enabled, delayProfiles, nightMode, nightDelayMultiplier | Human-like delay config |

#### Knowledge Base
| Table | Key Columns | Purpose |
|-------|-------------|---------|
| `products` | id, tenantId, sku, name, description, price, category, inStock, variants, images | Product catalog |
| `knowledgeDocs` | id, tenantId, title, content, category, docType, tags | Knowledge base articles |
| `knowledgeDocChunks` | id, docId, tenantId, chunkIndex, content, tokenCount | Document chunks for RAG |
| `ragDocuments` | id, tenantId, type (PRODUCT/DOC), sourceId, content, metadata | RAG document wrappers |
| `ragChunks` | id, ragDocumentId, chunkText, chunkIndex, tokenCount, embedding | RAG chunks with embeddings |

#### Vehicle Lookup
| Table | Key Columns | Purpose |
|-------|-------------|---------|
| `vehicleLookupCache` | id, lookupKey (unique), idType, rawValue, normalizedValue, result (jsonb), source, expiresAt | Cached VIN/FRAME lookup results |
| `vehicleLookupCases` | id, tenantId, conversationId, messageId, idType, status, verificationStatus, cacheId | Per-conversation lookup tracking |

#### Pricing
| Table | Key Columns | Purpose |
|-------|-------------|---------|
| `priceSnapshots` | id, tenantId, oem, source, min/max/avgPrice, market_* prices, salePrice, marginPct, searchKey | Cached price lookup results |
| `internalPrices` | id, tenantId, oem, price, condition, supplier | Tenant's own price list. Unique: (tenantId, oem, condition, supplier) |

#### Analytics
| Table | Key Columns | Purpose |
|-------|-------------|---------|
| `csatRatings` | id, tenantId, conversationId, rating (1-5), comment | Customer satisfaction |
| `conversions` | id, tenantId, conversationId, amount, intent, decision | Sales conversions |
| `lostDeals` | id, tenantId, conversationId, reason, detectedAutomatically | Lost deal tracking |

#### Billing
| Table | Key Columns | Purpose |
|-------|-------------|---------|
| `plans` | id, name, amount, currency, cryptoAmount, cryptoAsset, interval | Subscription plans |
| `subscriptions` | id, tenantId (unique), planId, status, paymentProvider, currentPeriodStart/End, trialStartedAt/EndsAt | Active subscriptions |
| `subscriptionGrants` | id, tenantId, startsAt, endsAt, grantedByUserId, revokedAt | Admin-granted subscription periods |

#### Onboarding & Readiness
| Table | Key Columns | Purpose |
|-------|-------------|---------|
| `onboardingState` | tenantId (PK), status, currentStep, completedSteps, answers | Onboarding progress |
| `readinessReports` | id, tenantId, score, checks, recommendations | System readiness assessments |

#### Channels
| Table | Key Columns | Purpose |
|-------|-------------|---------|
| `telegramSessions` | id, tenantId, channelId, phoneNumber, sessionString, authMethod, isEnabled, status, username | Telegram MTProto session storage |

#### Platform
| Table | Key Columns | Purpose |
|-------|-------------|---------|
| `featureFlags` | id, name, description, enabled, tenantId | Feature flags (global and per-tenant) |
| `auditEvents` | id, tenantId, actor, action, entityType, entityId, metadata, requestId, ipAddress | Audit trail |
| `integrationSecrets` | id, scope, tenantId, keyName, encryptedValue, encryptionMeta | AES-256-GCM encrypted secrets |
| `updateHistory` | id, version, filename, status, backupPath, appliedAt | OTA update history |
| `proxies` | id, host, port, protocol, status, assignedTenantId, assignedChannelId | Proxy pool for channel connections |
| `channelFingerprints` | id, channelType, fingerprintHash, tenantId, isBlocked | Anti-fraud channel fingerprinting |
| `fraudFlags` | id, tenantId, reason, metadata, resolvedAt | Fraud detection flags |

---

## API Endpoints

### Auth (`/auth/*`)
| Method | Path | Description |
|--------|------|-------------|
| POST | `/auth/signup` | Create account (with optional invite token) |
| POST | `/auth/login` | Login (rate limited: 5/15min) |
| POST | `/auth/logout` | Logout |
| GET | `/auth/me` | Current user info |
| POST | `/auth/invite` | Create invite (MANAGE_USERS) |
| POST | `/auth/send-verification` | Send email verification |
| POST | `/auth/verify-email` | Verify email token |
| POST | `/auth/forgot-password` | Request password reset |
| POST | `/auth/reset-password` | Reset password with token |
| GET | `/api/auth/user` | Session user info (legacy) |

### Tenant & Onboarding
| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/tenant` | Get current tenant |
| PATCH | `/api/tenant` | Update tenant settings |
| GET | `/api/onboarding/state` | Get onboarding progress |
| POST | `/api/onboarding/setup` | Initial tenant setup |
| POST | `/api/onboarding/complete-step` | Complete onboarding step |
| POST | `/api/onboarding/generate-templates` | Generate docs via AI |
| POST | `/api/onboarding/apply-templates` | Apply generated templates |
| POST | `/api/onboarding/run-smoke-test/stream` | Run Decision Engine smoke test (SSE) |

### Customers
| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/customers` | List customers (search, pagination) |
| GET | `/api/customers/:id` | Get customer detail |
| PATCH | `/api/customers/:id` | Update customer (tags, metadata) |
| DELETE | `/api/customers/:id/data` | GDPR data deletion |
| GET | `/api/customers/:id/notes` | Get customer notes |
| POST | `/api/customers/:id/notes` | Add customer note |
| GET | `/api/customers/:id/memory` | Get customer memory |
| PATCH | `/api/customers/:id/memory` | Update customer memory |

### Conversations & Messages
| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/conversations` | List conversations (filter by status) |
| GET | `/api/conversations/:id` | Get conversation detail |
| PATCH | `/api/conversations/:id` | Update conversation (status, mode) |
| POST | `/api/conversations/:id/read` | Mark as read |
| GET | `/api/conversations/:id/messages` | Get messages |
| POST | `/api/conversations/:id/messages` | Send manual message |
| POST | `/api/conversations/:id/generate` | Generate AI suggestion |

### AI Suggestions
| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/suggestions/:id/approve` | Approve suggestion |
| POST | `/api/suggestions/:id/edit` | Edit and send suggestion |
| POST | `/api/suggestions/:id/reject` | Reject suggestion |
| POST | `/api/suggestions/:id/escalate` | Escalate conversation |

### Dashboard & Analytics
| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/dashboard/metrics` | Dashboard metrics |
| GET | `/api/analytics/csat` | CSAT analytics |
| GET | `/api/analytics/conversion` | Conversion analytics |
| GET | `/api/analytics/intents` | Intent analytics |
| GET | `/api/analytics/lost-deals` | Lost deals analytics |
| POST | `/api/conversations/:id/csat` | Submit CSAT rating |
| GET | `/api/conversations/:id/csat` | Get CSAT for conversation |
| POST | `/api/conversations/:id/conversion` | Submit conversion |

### Settings
| Method | Path | Description |
|--------|------|-------------|
| GET/PUT | `/api/settings/decision` | Decision Engine settings |
| GET/PUT | `/api/settings/human-delay` | Human delay settings |
| GET/PUT | `/api/admin/training-policies` | Training policies |
| GET | `/api/admin/training-samples` | Training samples |
| GET | `/api/admin/learning-queue` | Learning queue |
| PATCH | `/api/admin/learning-queue/:id` | Mark reviewed |
| GET | `/api/admin/delayed-jobs` | Delayed message jobs |

### Vehicle Lookup & Pricing
| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/conversations/:id/vehicle-lookup-case` | Start vehicle lookup |
| GET | `/api/price-settings` | Get price settings |
| PUT | `/api/price-settings` | Update price settings (marginPct, roundTo, priceNote) |
| POST | `/api/conversations/:id/price-lookup` | Manual price lookup |
| GET | `/api/conversations/:id/price-history` | Price history |

### Channels
| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/channels/status` | All channel statuses |
| GET | `/api/channels/:type/config` | Channel config |
| POST | `/api/channels/:type/test` | Test channel connection |

### Telegram Personal
| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/telegram-personal/accounts` | List accounts |
| POST | `/api/telegram-personal/accounts/send-code` | Start phone auth |
| POST | `/api/telegram-personal/accounts/verify-code` | Verify phone code |
| POST | `/api/telegram-personal/accounts/verify-password` | 2FA password |
| POST | `/api/telegram-personal/accounts/start-qr` | Start QR auth |
| POST | `/api/telegram-personal/accounts/check-qr` | Check QR status |
| POST | `/api/telegram-personal/accounts/verify-qr-2fa` | 2FA for QR |
| POST | `/api/telegram-personal/accounts/cancel-auth` | Cancel auth |
| DELETE | `/api/telegram-personal/accounts/:id` | Delete account |
| PATCH | `/api/telegram-personal/accounts/:id` | Update account |
| POST | `/api/telegram-personal/start-conversation` | Start conversation by phone |

### WhatsApp Personal
| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/whatsapp-personal/start-auth` | Start QR auth |
| GET | `/api/whatsapp-personal/check-auth` | Check auth status |
| POST | `/api/whatsapp-personal/logout` | Logout |
| GET | `/api/whatsapp-personal/status` | Connection status |

### MAX Personal
| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/max-personal/start-auth` | Start auth |
| GET | `/api/max-personal/check-auth` | Check auth status |
| POST | `/api/max-personal/logout` | Logout |
| GET | `/api/max-personal/status` | Connection status |
| GET | `/api/max-personal/service-status` | Python service health |
| POST | `/api/max-personal/incoming` | Internal: incoming message from Python |

### Billing
| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/billing/me` | Current billing status |
| POST | `/api/billing/checkout` | Create payment (CryptoBot invoice) |
| POST | `/api/billing/check-invoice` | Check invoice status |
| POST | `/api/billing/cancel` | Cancel subscription |

### Products & Knowledge Base
| Method | Path | Description |
|--------|------|-------------|
| GET/POST | `/api/products` | Product CRUD |
| GET/PUT/DELETE | `/api/products/:id` | Single product operations |
| POST | `/api/products/import` | CSV import |
| GET/POST | `/api/knowledge-docs` | Knowledge doc CRUD |
| GET/PUT/DELETE | `/api/knowledge-docs/:id` | Single doc operations |

### Escalations
| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/escalations` | List escalations |
| PATCH | `/api/escalations/:id` | Resolve escalation |

### Webhooks
| Method | Path | Description |
|--------|------|-------------|
| POST | `/webhooks/telegram` | Telegram Bot webhook |
| GET/POST | `/webhooks/whatsapp` | WhatsApp Business webhook |
| POST | `/webhooks/max` | MAX Bot webhook |

### Platform Admin (`/api/admin/*`)
| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/admin/billing/metrics` | Billing metrics |
| GET | `/api/admin/tenants` | Search tenants |
| POST | `/api/admin/tenants/:id/restrict` | Restrict tenant |
| POST | `/api/admin/tenants/:id/unrestrict` | Unrestrict tenant |
| GET | `/api/admin/users` | Search users |
| POST | `/api/admin/users/:id/disable` | Disable user |
| POST | `/api/admin/users/:id/enable` | Enable user |
| POST | `/api/admin/users/:id/impersonate` | Impersonate user |
| GET/POST | `/api/admin/tenants/:id/grants` | Subscription grants |
| DELETE | `/api/admin/grants/:id` | Revoke grant |
| GET/POST | `/api/admin/secrets` | Integration secrets |
| POST | `/api/admin/secrets/:id/rotate` | Rotate secret |
| DELETE | `/api/admin/secrets/:id` | Revoke secret |
| GET/POST | `/api/admin/proxies` | Proxy management |
| POST | `/api/admin/proxies/parse` | Parse proxy string |
| POST | `/api/admin/proxies/import` | Bulk import proxies |
| GET | `/api/admin/updates` | Update history |
| POST | `/api/admin/updates/upload` | Upload update ZIP |
| POST | `/api/admin/updates/:id/apply` | Apply update |
| POST | `/api/admin/updates/:id/rollback` | Rollback update |
| POST | `/api/admin/system/rebuild` | Trigger system rebuild |
| GET | `/api/admin/feature-flags` | List feature flags |
| POST | `/api/admin/feature-flags/:name/toggle` | Toggle feature flag |
| GET | `/api/admin/audit-events` | Query audit events |
| GET | `/api/admin/security/readiness` | Security readiness report |
| GET | `/api/admin/system/metrics` | System metrics |

### Health
| Method | Path | Description |
|--------|------|-------------|
| GET | `/health` | Basic health check |
| GET | `/ready` | Readiness check (DB + OpenAI) |
| GET | `/metrics` | System metrics (uptime, memory) |

---

## External Integrations

### Telegram MTProto (gramjs)
- **Library:** `telegram` ^2.26.22
- **Usage:** `telegram-personal-adapter.ts`, `telegram-client-manager.ts`
- **API:** MTProto protocol via gramjs. `TelegramClient`, `StringSession`, `NewMessage` event handler.
- **Auth:** Phone + code + optional 2FA, or QR code
- **Config:** `TELEGRAM_API_ID`, `TELEGRAM_API_API_HASH` (from my.telegram.org)
- **Sessions:** Stored encrypted in `telegram_sessions` table

### Telegram Bot API
- **Library:** Custom HTTP client (fetch)
- **Usage:** `telegram-adapter.ts`
- **API:** `https://api.telegram.org/bot{token}/`
- **Config:** `TELEGRAM_BOT_TOKEN`, `TELEGRAM_WEBHOOK_SECRET`
- **Note:** Webhook handler only validates/logs — doesn't process messages through AI pipeline

### WhatsApp Business API (Meta Cloud API)
- **Library:** Custom HTTP client (fetch)
- **Usage:** `whatsapp-adapter.ts`
- **API:** `https://graph.facebook.com/v18.0/`
- **Config:** `WHATSAPP_API_TOKEN`, `WHATSAPP_PHONE_ID`
- **Note:** 24-hour customer care window enforced. Webhook handler doesn't process through AI.

### WhatsApp Personal (Baileys)
- **Library:** `@whiskeysockets/baileys` ^7.0.0-rc.9
- **Usage:** `whatsapp-personal-adapter.ts`
- **Auth:** QR code (WebSocket-based)
- **Sessions:** Filesystem (`./whatsapp_sessions/`) — single session per tenant
- **Incoming:** Routes through `processIncomingMessageFull`

### MAX Bot API
- **Library:** Custom HTTP client (fetch)
- **Usage:** `max-adapter.ts`
- **API:** `https://platform-api.max.ru/`
- **Config:** `MAX_BOT_TOKEN`, `MAX_WEBHOOK_SECRET`

### MAX Personal (Python Playwright)
- **Service:** `max_personal_service.py` (port 8100)
- **Client:** `max-personal-adapter.ts`
- **Auth:** QR code capture from web.max.ru via Playwright
- **Incoming:** Python POSTs to `POST /api/max-personal/incoming` with `X-Internal-Secret`
- **Spawned by:** `server/index.ts` as child process

### OpenAI API
- **Library:** `openai` ^6.15.0
- **Models:** `gpt-4o-mini` (decision engine, summaries), `gpt-4o` (onboarding templates)
- **Embeddings:** `text-embedding-3-large` (3072 dimensions) for RAG
- **Config:** `AI_INTEGRATIONS_OPENAI_API_KEY`, `AI_INTEGRATIONS_OPENAI_BASE_URL`
- **Fallback:** `sk-placeholder` if no key (allows startup without OpenAI)

### CryptoBot (CryptoPay)
- **Library:** `@foile/crypto-pay-api` ^1.0.4
- **Usage:** `cryptobot-billing.ts`
- **Config:** `CRYPTOBOT_API_TOKEN`
- **Payment:** 50 USDT/month invoices
- **Webhook:** HMAC-SHA256 signature verification

### Stripe
- **Library:** `stripe` ^20.2.0
- **Usage:** `billing-service.ts`
- **Config:** `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET`
- **Note:** Secondary payment provider. $50/month plan.

### Podzamenu Lookup (Python Playwright)
- **Service:** `podzamenu_lookup_service.py` (port 8200)
- **Client:** `podzamenu-lookup-client.ts`
- **Sites:** podzamenu.ru (React SPA with MUI), prof-rf (Chinese VINs)
- **Config:** `PODZAMENU_LOOKUP_SERVICE_URL`
- **Timeout:** 30s client-side, 60s server-side

### Avito / Drom (HTML Scraping)
- **Library:** `cheerio` ^1.2.0
- **Usage:** `avito-source.ts`, `drom-source.ts`
- **Config:** `AVITO_ENABLED`, `DROM_ENABLED`
- **Risk:** Selector-dependent; may break if sites change markup

### SerpAPI (Web Search)
- **Usage:** `web-source.ts`
- **API:** `https://serpapi.com/search.json`
- **Config:** `SERP_API_KEY`

---

## Environment Variables

### Required
| Variable | Description |
|----------|-------------|
| `AI_INTEGRATIONS_OPENAI_API_KEY` | OpenAI API key for GPT and embeddings |
| `AI_INTEGRATIONS_OPENAI_BASE_URL` | OpenAI API base URL (default: `https://api.openai.com/v1`) |
| `SESSION_SECRET` | Express session secret (min 32 chars) |
| `INTEGRATION_SECRETS_MASTER_KEY` | AES-256-GCM master key for encrypting secrets (32 bytes, base64) |
| `DATABASE_URL` | PostgreSQL connection URL |

### Server
| Variable | Description |
|----------|-------------|
| `NODE_ENV` | Environment: development / staging / production |
| `PORT` | Server port (default: 5000) |
| `TRUST_PROXY` | Enable trust proxy for reverse proxy (Cloudflare/Nginx) |

### Telegram
| Variable | Description |
|----------|-------------|
| `TELEGRAM_BOT_TOKEN` | Bot API token |
| `TELEGRAM_WEBHOOK_SECRET` | Webhook verification secret |
| `TELEGRAM_API_ID` | MTProto API ID (numeric, from my.telegram.org) |
| `TELEGRAM_API_API_HASH` | MTProto API hash (32-char hex) |

### WhatsApp
| Variable | Description |
|----------|-------------|
| `WHATSAPP_API_TOKEN` | Business API token |
| `WHATSAPP_PHONE_ID` | Phone number ID |

### MAX
| Variable | Description |
|----------|-------------|
| `MAX_BOT_TOKEN` | MAX Bot API token |
| `MAX_WEBHOOK_SECRET` | MAX webhook verification secret |
| `MAX_SERVICE_URL` | MAX Personal Python service URL (default: `http://localhost:8100`) |
| `MAX_INTERNAL_SECRET` | Internal secret for MAX Personal → Node communication |

### Vehicle Lookup
| Variable | Description |
|----------|-------------|
| `PODZAMENU_LOOKUP_SERVICE_URL` | Podzamenu Python service URL (default: `http://localhost:8200`) |

### Price Engine
| Variable | Description |
|----------|-------------|
| `AVITO_ENABLED` | Enable Avito price source (default: false) |
| `DROM_ENABLED` | Enable Drom price source (default: false) |
| `SERP_API_KEY` | SerpAPI key for web search (empty = disabled) |

### Billing
| Variable | Description |
|----------|-------------|
| `CRYPTOBOT_API_TOKEN` | CryptoBot API token |
| `STRIPE_SECRET_KEY` | Stripe secret key |
| `STRIPE_WEBHOOK_SECRET` | Stripe webhook secret |

### Platform Owner (Bootstrap)
| Variable | Description |
|----------|-------------|
| `OWNER_EMAIL` | Platform owner email |
| `OWNER_PASSWORD` | Platform owner password (remove after first run) |
| `OWNER_PASSWORD_HASH` | Platform owner bcrypt hash (alternative to plain password) |
| `OWNER_NAME` | Platform owner display name |

### Rate Limiting
| Variable | Description |
|----------|-------------|
| `RATE_LIMIT_MAX_REQUESTS` | Max API requests/minute (default: 100) |
| `RATE_LIMIT_AI_MAX_REQUESTS` | Max AI generation requests/minute (default: 20) |

### Logging & Monitoring
| Variable | Description |
|----------|-------------|
| `LOG_LEVEL` | Pino log level: debug/info/warn/error |
| `SENTRY_DSN` | Sentry error tracking DSN |

### Feature Flags (can be overridden via API)
| Variable | Description |
|----------|-------------|
| `FEATURE_AI_SUGGESTIONS_ENABLED` | Enable AI suggestions (default: true) |
| `FEATURE_RAG_ENABLED` | Enable RAG (default: true) |
| `FEATURE_AI_AUTOSEND_ENABLED` | Enable auto-send (default: false) |
| `FEATURE_HUMAN_DELAY_ENABLED` | Enable human delay (default: false) |
| `FEATURE_DECISION_ENGINE_ENABLED` | Enable Decision Engine (default: false) |

---

## Data Flows

### 1. User Registration → Trial → Subscription
```
User visits /signup → POST /auth/signup →
  authService.signup():
    Create user (bcrypt password) → Create/find tenant →
    fraudDetectionService.checkTrialEligibility() →
    cryptoBotBilling.startTrial() (72h) →
    Set session → Redirect to /onboarding

Onboarding:
  6 steps: BUSINESS → CHANNELS → PRODUCTS → POLICIES → KB → REVIEW
  → Each step: POST /api/onboarding/complete-step
  → REVIEW: smoke test via Decision Engine

Subscription:
  GET /api/billing/me → getBillingStatus()
  POST /api/billing/checkout → CryptoBot invoice (50 USDT)
  User pays → CryptoBot webhook → handleWebhookEvent()
  → Update subscription status to "active"
```

### 2. Incoming Message → AI Response
```
Customer sends message (Telegram/WhatsApp/MAX Personal)
  ↓
Channel adapter receives message
  ↓
processIncomingMessageFull(tenantId, parsed):
  1. handleIncomingMessage():
     - Find/create customer by externalId
     - Find/create conversation
     - Deduplicate by externalMessageId
     - Save message to DB
     - WebSocket broadcast: new_message, conversation_update
  2. detectVehicleIdFromText():
     - Normalize: кириллица→латиница (12 pairs), тире→дефис
     - Regex: VIN (17 chars) → FRAME (with dash) → FRAME dashless (8-14 chars)
     - If VIN/FRAME found:
       → Create vehicle_lookup_case (PENDING)
       → Create suggestion: "Начал проверку по VIN..."
       → enqueueVehicleLookup (BullMQ)
     - If no VIN but gearbox type mentioned:
       → Create suggestion: gearboxNoVin template
  3. triggerAiSuggestion():
     - Check: no pending suggestion exists
     - generateWithDecisionEngine():
       → RAG context (embeddings + cosine similarity)
       → Few-shot examples from training samples
       → GPT-4o-mini: generate response + intent + confidence
       → Penalties (stale data, missing fields, price mentions)
       → Decision: AUTO_SEND / NEED_APPROVAL / ESCALATE
       → Self-check: separate GPT call
       → Autosend eligibility check
     - Save suggestion to DB
     - WebSocket broadcast: new_suggestion
```

### 3. VIN Lookup → Price Lookup
```
Vehicle Lookup Worker (BullMQ):
  1. Check cache (vehicle_lookup_cache)
  2. If miss → POST to Python Podzamenu service
     → Playwright navigates podzamenu.ru or prof-rf
     → Parses gearbox info: model, factoryCode, OEM, oemCandidates
  3. Compute confidence (0.5 base + bonuses/penalties)
  4. Save to cache, update case status
  5. Create suggestion from gearbox template
  6. If confidence ≥ 0.85 AND OEM found:
     → enqueuePriceLookup(oem)
  7. If OEM not found but gearbox type detected:
     → tryFallbackPriceLookup(make, model, gearboxType)

Price Lookup Worker (BullMQ):
  1. Check cache (price_snapshots, 60 min TTL)
  2. Cascade: internal_prices → Avito → Drom → Web (SerpAPI) → Mock
  3. Apply commercial logic:
     - Market prices → Apply marginPct (default -25%)
     - Round to nearest roundTo (default 100)
     - Add priceNote
  4. Auto-save external prices to internal_prices
  5. Create price suggestion for conversation
  6. WebSocket broadcast
```

### 4. Operator Actions
```
Operator sees suggestion in UI:
  → Approve: POST /api/suggestions/:id/approve
    → Send message via channel adapter
    → Record training sample (outcome: APPROVED)
    → Calculate learning score
  → Edit: POST /api/suggestions/:id/edit
    → Send edited text via channel adapter
    → Record training sample (outcome: EDITED)
  → Reject: POST /api/suggestions/:id/reject
    → Record training sample (outcome: REJECTED)
  → Escalate: POST /api/suggestions/:id/escalate
    → Create escalation event
    → Change conversation status
```

---

## Feature Flags

From `feature_flags.json` with their usage in code:

| Flag | Default | Used In |
|------|---------|---------|
| `AI_SUGGESTIONS_ENABLED` | **true** | `inbound-message-handler.ts` — gates `triggerAiSuggestion` |
| `DECISION_ENGINE_ENABLED` | **false** | `decision-engine.ts` — if off, uses simpler generation |
| `AI_AUTOSEND_ENABLED` | **false** | `decision-engine.ts` — gates auto-send without approval |
| `HUMAN_DELAY_ENABLED` | **false** | `message-queue.ts`, `human-delay-engine.ts` — gates delayed sending |
| `RAG_ENABLED` | **true** | `embedding-service.ts`, `rag-retrieval.ts` — gates RAG context |
| `FEW_SHOT_LEARNING` | **true** | `few-shot-builder.ts` — gates few-shot examples in prompts |
| `TELEGRAM_CHANNEL_ENABLED` | **false** | `channel-adapter.ts`, `telegram-webhook.ts` — Bot API channel |
| `WHATSAPP_CHANNEL_ENABLED` | **false** | `channel-adapter.ts`, `whatsapp-webhook.ts` — Business API channel |
| `MAX_CHANNEL_ENABLED` | **false** | `channel-adapter.ts`, `max-webhook.ts` — Bot API channel |
| `TELEGRAM_PERSONAL_CHANNEL_ENABLED` | **true** | `telegram-client-manager.ts` — Personal (MTProto) |
| `WHATSAPP_PERSONAL_CHANNEL_ENABLED` | **true** | `whatsapp-personal-adapter.ts` — Personal (Baileys) |
| `MAX_PERSONAL_CHANNEL_ENABLED` | **true** | `max-personal-adapter.ts` — Personal (Playwright) |

**Note:** Bot/Business API channels are all disabled by default. Only Personal channels are enabled. This means the webhook handlers for Bot APIs are essentially inactive.

---

## Known Issues & Technical Debt

### Critical Bugs
1. **`conversion-service.ts`** — `conversionRate` calculation divides `totalConversions / totalConversions` instead of `totalConversions / totalConversations`, always returning 100%.
2. **`auth-utils.ts` (client)** — `redirectToLogin` sends users to `/api/login` instead of `/login`.
3. **`conversation-list.tsx`** — Search input is not wired to any state; searching does nothing.

### Security Concerns
4. **WebSocket server** — ~~FIXED: session cookie verified on upgrade, tenant bound from authenticated user. Unauthenticated connections rejected in production.~~
5. **RBAC middleware** in production always returns `operator` role — no real session/JWT verification. `X-Debug-Role` header only works in non-production, but production auth is effectively non-functional for RBAC.
6. **Audit log** (`audit-log.ts`) stores events only in memory — lost on restart, not persisted to `auditEvents` DB table.
7. **`security-readiness.ts`** — Webhook verification, rate limiting, and data deletion checks always return `true` regardless of actual state.
8. **`sk-placeholder`** used as fallback OpenAI API key in `decision-engine.ts`, `customer-summary-service.ts`, `onboarding-templates.ts` — allows startup but will fail on actual API calls.

### Incomplete Implementations
9. **Email provider** — Only `ConsoleEmailProvider` exists (logs to console). No real email sending.
10. **`message-send.worker.ts`** — `isMessageStillValid()` always returns true; `markMessageAsSent/Failed` only log without DB updates.
11. **`extractCategoryFromSample`** in `few-shot-builder.ts` always returns `null`.
12. **Dashboard trends** (`dashboard.tsx`) are hardcoded static values (`+12%`, `-15%`, etc.).
13. **Telegram/WhatsApp/MAX Bot API webhooks** validate and log but do NOT process messages through the AI pipeline or save to DB.

### Code Quality
14. **Duplicate batch utils** — `server/replit_integrations/batch/utils.ts` is a near-copy of `server/batch/utils.ts`.
15. **Legacy chat schema** — `shared/models/chat.ts` defines a legacy schema (serial IDs, no tenantId) that appears unused.
16. **Many `as any` type casts** throughout the codebase, especially in adapters, audit log, and middleware.
17. **Feature flags persisted to JSON file** — not suitable for multi-process deployments.
18. **`update-service.ts`** uses Unix-only commands (`unzip`, `cp -r`) — incompatible with Windows.
19. **Two migration files with `0006` prefix** (`0006_internal_prices.sql` and `0006_telegram_multiaccount.sql`) — may cause ordering confusion.
20. **Price lookup queue** has no job deduplication (unlike vehicle lookup queue which uses `case_${caseId}`).
21. **RAG retrieval** loads all tenant chunks into memory for similarity comparison — will not scale for large tenants.
22. **`max_personal` channel** exists in schema `CHANNEL_TYPES` and feature flags but is missing from `CHANNEL_FLAG_MAP` in `channel-adapter.ts`.

### Hardcoded Values
23. All UI strings are in Russian with no i18n framework.
24. Price plan: 50 USDT/month, $50 Stripe — hardcoded in billing services.
25. Trial duration: 72 hours — hardcoded in `cryptobot-billing.ts`.
26. Telegram account limit: 5 per tenant — hardcoded.
27. Many timeouts hardcoded (15s Avito/Drom, 20s web, 30s podzamenu client, 60s podzamenu server).

---

## Documentation vs Reality

### README.md
- **Claims:** "Telegram Personal integration via gramjs with QR authentication" — **Correct**
- **Claims:** "Subscription-based access (50 USDT/month via CryptoBot)" — **Correct**
- **Claims:** "3-day free trial" — **Correct** (72h in code)
- **Missing:** No mention of WhatsApp, MAX, VIN lookup, price engine, or any of the major features.

### AGENT_CAPABILITIES_AND_PLAN.md
- Lists features by module — **mostly accurate** for what's implemented.
- **Discrepancy:** Lists "Stripe billing" as primary — code shows **CryptoBot as primary**, Stripe as secondary.
- **Discrepancy:** Lists "Email verification and password reset" — **email provider only logs to console**, never sends.

### INTEGRATION_MAP_GEARBOX_OEM.md
- **Accurate** for the VIN/FRAME detection pipeline, vehicle lookup flow, and price cascade.
- **Discrepancy:** States WhatsApp Personal calls `processIncomingMessageFull` at "lines ~396, 450, 616, 670" — actual line numbers may have shifted.
- **Missing:** Does not document the `gearboxNoVin` flow (VIN not found + gearbox type mentioned).

### PLAN_PODZAMENU_LOOKUP.md
- **Accurate** as an implementation plan — the architecture described matches what was built.
- **Outdated:** Plan mentions "Python FastAPI or Node" for the service — only Python was implemented.
- **Missing:** Does not mention prof-rf (Chinese VIN) source or the dual navigation strategies.

### Master Prompt (User Rules)
- **Most comprehensive** and largely accurate.
- **Discrepancy:** States `enqueuePriceLookup` is called from vehicle worker — **correct**, but also callable from routes for manual price lookup.
- **Discrepancy:** States "Авто-сохранение цен в internal_prices" is fully ready — code shows `autoSaveToInternal` skips when `oem` is null (fallback mode).
- **Missing from "Полностью готово":** The RBAC middleware returns hardcoded `operator` role in production — real RBAC is not functional.
- **Missing from "В разработке":** Email sending (only console), audit persistence.

---

*Generated by full codebase audit. 268 files analyzed across 137 server TypeScript files, 88 client files, 3 shared files, 12 migration files, 3 Python files, and root configs.*
